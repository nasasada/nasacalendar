<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Zen+Old+Mincho&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@400;500&display=swap" rel="stylesheet">

  <link rel="icon" href="hdml.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="hdml.ico">
  <meta name="theme-color" content="#ffffff">

  <title>ã²ã ã¾ã‚Šã‚­ãƒƒãƒãƒ³ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
  <style>

    body {
      font-family: 'Zen Maru Gothic', sans-serif;
      color: #444;
      margin: 0;
      padding: 0;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      border-top: 1px solid #ccc;
      border-left: 1px solid #ccc;
    }




    .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 8px;
    font-size: 14px;
    font-weight: bold;
    }

        
    #monthYear {
      display: flex;
      align-items: baseline; /* æ–‡å­—ã®ä¸‹ãƒ©ã‚¤ãƒ³ã‚’æƒãˆã‚‹ */
      gap: 50px;
    }

    .month-num {    
      font-family: 'Zen Maru Gothic', sans-serif;
      /*font-family: 'Inter', sans-serif; */
      font-size: 50px;
      font-weight: 1000;
      position: relative;
      top: 7px;
    }

    .month-name {
      font-family: 'Zen Maru Gothic', sans-serif;
      /*font-family: 'Cormorant Garamond', serif; */
      font-size: 28px;
      letter-spacing: 0.06em;
    }




    .weekday-header {
      font-family: 'Zen Maru Gothic', sans-serif;
      /*      font-family: 'Cormorant Garamond', serif; */
      background: #f0f0f0;
      text-align: center;
      font-weight: bold;
      font-size: 16px;
      height: 30px;       /* â† ã“ã®è¡Œã‚’è¿½åŠ /èª¿æ•´ */
      line-height: 30px;  /* â† ç¸¦ä¸­å¤®æƒãˆ */
      color: #666;
      border-right: 1px solid #ccc;  /* å³å´ã«ç¸¦ç·š */
      border-bottom: 1px solid #ccc;
    }

    .weekday-header.sun {
    color: rgb(167, 59, 59); /* èµ¤ï¼ˆæ—¥æ›œï¼‰ */
    }

    .weekday-header.sat {
    color: rgb(59, 59, 136); /* é’ï¼ˆåœŸæ›œï¼‰ */
    }

    .day {
      min-height: 120px; /* æœ€ä½é™ã®é«˜ã• */
      height: auto;      /* ä¸­èº«ã«åˆã‚ã›ã¦ä¼¸ã³ã‚‹ */
      border-right: 1px solid #ccc;
      border-bottom: 1px solid #ccc;
      padding: 3px 1px;
      box-sizing: border-box;
      overflow-y: auto;
      font-size: 14px;
      position: relative;
      overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡åŠ¹åŒ– */
    }
    .day-header {
      border-right: 1px solid #ccc;
      border-bottom: 1px solid #ccc;
      padding: 3px 1px;
      box-sizing: border-box;
      height: 160px;
      overflow-y: auto;
      font-size: 14px;
      position: relative;
      overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡åŠ¹åŒ– */
    }

    .date-label-wrapper {
    display: flex;
    align-items: center;
    gap: 4px;
    }

    .date-number {
    font-weight: bold;
    font-family: 'Zen Maru Gothic', sans-serif;
    font-size: 14px;
    }



    .sun {
      background-color: #ffe5e5;
    }
    .sat {
      background-color: #e5f0ff;
    }
    .holiday {
      background-color: #ffe5e5 !important;
    }
    .holiday-label {
    font-weight: bold;
    font-size: 13px;
    color: #d9534f;  /* èµ¤ã£ã½ã„è‰² */
    margin-left: 4px;
    }

    .today {
    background-color: #a4f7fd !important; /* æ°´è‰²èƒŒæ™¯ */
    }
    .today-label {
    font-weight: bold;
    font-size: 13px;
    color: #003caa;
    margin-left: 4px;
    }


    .event {
      font-size: 14px;
      line-height: 1.2;
      margin: 1px 0px;
      margin-bottom: 1px; /* åŒæ—¥å†…è¤‡æ•°ã‚¤ãƒ™ãƒ³ãƒˆã®éš™é–“ */
      padding: 1px 0px;
      border-radius: 3px;
      color: white;
      display: block;
      white-space: normal;
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 100%;
      box-sizing: border-box;
      word-break: break-word;
    }

    .closed-day {
      width: 52px;
      height: 52px;
      margin: 12px auto 0;
      border-radius: 50%;
      background-color: #f4c20d; /* Googleã£ã½ã„é»„è‰² */
      color: #fff;
      font-size: 20px;
      line-height: 52px;
      text-align: center;
    }

    .color-1  { background:#1a73e8; } /* é’ */
    .color-2  { background:#34a853; } /* ç·‘ */
    .color-3  { background:#fbbc04; } /* é»„ */
    .color-4  { background:#ea4335; } /* èµ¤ */
    .color-5  { background:#4285f4; } /* æ°´è‰² */
    .color-6  { background:#f0932b; } /* ã‚ªãƒ¬ãƒ³ã‚¸ */
    .color-7  { background:#8e24aa; } /* ç´« */
    .color-8  { background:#9e9e9e; } /* ã‚°ãƒ¬ãƒ¼ */
    .color-9  { background:#eb5d8c; } /* ãƒ”ãƒ³ã‚¯ */
    .color-10 { background:#c05d39; } /* èŒ¶è‰² */

    .color-11 { background:#0b8043; } /* æ¿ƒç·‘ */
    .color-12 { background:#c0ca33; } /* é»„ç·‘ */
    .color-13 { background:#174ea6; } /* æ¿ƒé’ */
    .color-14 { background:#b31412; } /* ãƒ¯ã‚¤ãƒ³ */
    .color-15 { background:#00acc1; } /* ã‚¿ãƒ¼ã‚³ã‚¤ã‚º */
    .color-16 { background:#212121; } /* é»’ */
    .color-17 { background:#d7ccc8; } /* ãƒ™ãƒ¼ã‚¸ãƒ¥ */
    .color-18 { background:#1f3a8a; } /* ãƒã‚¤ãƒ“ãƒ¼ */
    .color-19 { background:#808000; } /* ã‚ªãƒªãƒ¼ãƒ– */
    .color-20 { background:#424242; } /* ã‚°ãƒ©ãƒ•ã‚¡ã‚¤ãƒˆ */


    .thumbnail {
      width: 94%;
      aspect-ratio: 1 / 1; /*æ­£æ–¹å½¢*/
      object-fit: cover;
      display: block;
      margin: 3px auto 3px; /* â† auto ãŒä¸­å¤®å¯„ã› */
      border-radius: 12px; /*ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã®ä¸¸ã¿*/
    }

    .event.has-thumbnail {
      padding-left: 4px;
      padding-right: 4px;
      font-family: 'Zen Maru Gothic', sans-serif;
      font-size: 13px;
      letter-spacing: 0.13em;   /* â† ã“ã“ãŒè‚ */
      padding-bottom: 2px;
    }

    .event.no-thumbnail {
      display: flex;
      flex-direction: column;
      justify-content: center;   /* ç¸¦ä¸­å¤® */
      align-items: center;       /* æ¨ªä¸­å¤® */
      padding: 10px 6px;
      text-align: center;
      font-family: 'Zen Maru Gothic', sans-serif;
      font-size: 18px;
      font-weight: 500;
      letter-spacing: 0.18em;   /* â† ã“ã“ãŒè‚ */
      line-height: 1.5;
      border-radius: 18px;   /* å¥½ã¿ã§ 12ã€œ18px */
    }

    .event-time {
      font-size: 13px;
      opacity: 0.9;
      line-height: 1.2;
    }

    .event-title {
      font-size: 19px;
      line-height: 1.3;
      margin-top: 2px;
    }



    #prevMonth, #nextMonth {
      font-family: 'Zen Maru Gothic', sans-serif;
      /*      font-family: 'Cormorant Garamond', serif; */
      font-size: 20px;      /* æ–‡å­—ã‚’å¤§ãã */
      padding: 8px 20px;   /* ãƒœã‚¿ãƒ³ã®å†…å´ã®ä½™ç™½ã‚’å¢—ã‚„ã™ */
      min-width: 80px;      /* å¹…ã®æœ€å°å€¤ */
      min-height: 40px;     /* é«˜ã•ã®æœ€å°å€¤ */
      cursor: pointer;      /* ãƒ›ãƒãƒ¼æ™‚ã®ã‚«ãƒ¼ã‚½ãƒ« */
      border-radius: 6px;   /* è§’ã‚’å°‘ã—ä¸¸ã */
      user-select: none;    /* ã‚¯ãƒªãƒƒã‚¯æ™‚ã«æ–‡å­—é¸æŠã•ã‚Œãªã„ */
    }


    @media screen and (max-width: 600px) {
    .event {
      font-size: 10px;
      margin: 2px 0px;
      padding: 1px 0px;
    }

    .event-title {
      font-size: 15px;
    }
    
    #monthYear {
      align-items: baseline; /* æ–‡å­—ã®ä¸‹ãƒ©ã‚¤ãƒ³ã‚’æƒãˆã‚‹ */
      gap: 11px;
    }

    .month-num {
      top: 2px;
      font-size: 35px;
    }
    .month-name {
      font-size: 17px;
    }

    .calendar-header {
      margin: 4px 6px;   /* ä¸Šä¸‹ã‚’è©°ã‚ã‚‹ */
    }

    .day {
      min-height: 70px; /* æœ€ä½é™ã®é«˜ã• */
      height: auto;      /* ä¸­èº«ã«åˆã‚ã›ã¦ä¼¸ã³ã‚‹ */
    }

    .day-header {
      font-size: 11px; /* å…¨ä½“çš„ã«æ–‡å­—ã‚’å°‘ã—å°ã•ã */
      height: 130px;   /* é«˜ã•ã‚‚å°‘ã—ä½ãã—ã¦ã‚¹ãƒãƒ›ã«åˆã‚ã›ã‚‹ */
    }
    
    .date-label-wrapper {
    gap: 1px;  /* â† ã‚¹ãƒãƒ›æ™‚ã¯ä½™ç™½ã‚’å°ã•ã‚ã« */
    }
    .weekday-header {
      font-size: 12px;
      height: 22px;
      line-height: 22px;
    }
    
    .holiday-label  {
    font-size: 7px;
    }

    .today-label {
    font-size: 10px;
    }

    .closed-day {
      width: 30px;
      height: 30px;
      margin: 4px auto 0;
      border-radius: 50%;
      font-size: 18px;
      line-height: 30px;
    }


    .thumbnail {
      width: 96%;
      aspect-ratio: 1 / 1;
      object-fit: cover;
      display: block;
      margin: 2px auto 2px; /* â† auto ãŒä¸­å¤®å¯„ã› */
      border-radius: 8px; /*ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã®ä¸¸ã¿*/
    }

    .event.has-thumbnail {
      padding-left: 3px;
      padding-right: 3px;
      font-family: 'Zen Maru Gothic', sans-serif;
      font-size: 10px;
      letter-spacing: 0.1em;   /* â† ã“ã“ãŒè‚ */
      padding-bottom: 2px;
    }

    .event.no-thumbnail {
      display: flex;
      flex-direction: column;
      justify-content: center;   /* ç¸¦ä¸­å¤® */
      align-items: center;       /* æ¨ªä¸­å¤® */
      padding: 10px 6px;
      text-align: center;
      font-family: 'Zen Maru Gothic', sans-serif;
      font-size: 5px;
      font-weight: 500;
      letter-spacing: 0.08em;   /* â† ã“ã“ãŒè‚ */
      line-height: 1.5;
      border-radius: 15px;   /* å¥½ã¿ã§ 12ã€œ18px */
    }

    .event-time {
      font-size: 10px;
      opacity: 0.9;
      line-height: 1.2;
    }

    .event-title {
      font-size: 16px;
      line-height: 1.3;
      margin-top: 2px;
    }


  }


  </style>
</head>







<body>


    <div class="calendar-header">
    <button id="prevMonth">Last</button>
    <h2 id="monthYear"></h2>
    <button id="nextMonth">Next</button>
    </div>

    <div class="calendar">

    </div>






  <script>
        const now = new Date();
        let currentYear = now.getFullYear();
        let currentMonth = now.getMonth(); // 0-11

        const calendarEl = document.querySelector(".calendar");





        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†æç”»ç”¨
        async function renderCalendar(year, month) {
        calendarEl.innerHTML = ""; // æ—¢å­˜ã‚¯ãƒªã‚¢



        // ğŸŒŸ æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
        const weekdays = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
        weekdays.forEach((day, index) => {
            const headerCell = document.createElement("div");
            headerCell.className = "weekday-header";

            if (index === 6) headerCell.classList.add("sun");  // æ—¥æ›œ
            if (index === 5) headerCell.classList.add("sat");  // åœŸæ›œ

            headerCell.textContent = day;
            calendarEl.appendChild(headerCell);
        });

        const firstDay = new Date(year, month, 1);
        const rawStartDay = firstDay.getDay(); // 0=æ—¥æ›œ, 1=æœˆæ›œ, ...
        const startDay = (rawStartDay + 6) % 7; // æœˆæ›œ=0, æ—¥æ›œ=6 ã«å¤‰æ›


        // å‰æœˆã®æƒ…å ±
        const prevMonth = month - 1 < 0 ? 11 : month - 1;
        const prevYear = month - 1 < 0 ? year - 1 : year;
        const prevMonthLastDate = new Date(prevYear, prevMonth + 1, 0).getDate();

        // å½“æœˆã®æ—¥æ•°
        const daysInMonth = new Date(year, month + 1, 0).getDate();


        // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæœˆãƒ©ãƒ™ãƒ«ï¼‰æ›´æ–°
        // è‹±èªã®æœˆå
        const MONTH_NAMES = [
          "January", "February", "March", "April", "May", "June",
          "July", "August", "September", "October", "November", "December"
        ];

        // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæœˆãƒ©ãƒ™ãƒ«ï¼‰æ›´æ–°
        document.getElementById("monthYear").innerHTML =
          `<span class="month-num">${month + 1}</span>
          <span class="month-name">${MONTH_NAMES[month]} ï½œ ${year}</span>`;
          
          
                
        // ğŸŒŸ å‰æœˆã®æ—¥ä»˜ã‚»ãƒ«ã‚’è¿½åŠ ï¼ˆç©ºç™½ã§ã¯ãªãï¼‰
        for (let i = startDay - 1; i >= 0; i--) {
            const date = new Date(prevYear, prevMonth, prevMonthLastDate - i);
            const div = document.createElement("div");
            div.className = "day";
            div.setAttribute("data-day", formatDateKey(date));

            const dow = date.getDay();
            if (dow === 0) div.classList.add("sun");
            if (dow === 6) div.classList.add("sat");

            // æœ¬æ—¥åˆ¤å®š
            const now = new Date();
            const isToday = (
                date.getFullYear() === now.getFullYear() &&
                date.getMonth() === now.getMonth() &&
                date.getDate() === now.getDate()
            );
            if (isToday) div.classList.add("today");

            // ãƒ©ãƒ™ãƒ«è¡¨ç¤º
            const dateLabelWrapper = document.createElement("div");
            dateLabelWrapper.className = "date-label-wrapper";

            const dateNumber = document.createElement("span");
            dateNumber.className = "date-number";
            dateNumber.textContent = date.getDate();
            dateLabelWrapper.appendChild(dateNumber);

            div.appendChild(dateLabelWrapper);

            // ğŸ‚ ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç‰¹åˆ¥ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’å‡ºã™
            div.addEventListener("dblclick", () => {
              const clickedDate = formatDateKey(date);  // "YYYY-MM-DD" å½¢å¼
              handleDayDblClick(clickedDate);
            });

            calendarEl.appendChild(div);
        }



        // ğŸŒŸ 2. å½“æœˆã®æ—¥ä»˜ã‚»ãƒ«ã‚’è¿½åŠ 
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const div = document.createElement("div");
            div.className = "day";
            div.setAttribute("data-day", formatDateKey(date));

            const dow = date.getDay();
            if (dow === 0) div.classList.add("sun");
            if (dow === 6) div.classList.add("sat");

            // æœ¬æ—¥åˆ¤å®š
            const now = new Date();
            const isToday =
                    date.getFullYear() === now.getFullYear() &&
                    date.getMonth() === now.getMonth() &&
                    date.getDate() === now.getDate();
            if (isToday) div.classList.add("today");

            // æ—¥ä»˜ãƒ©ãƒ™ãƒ«ãƒ»ç¥æ—¥ãƒ©ãƒ™ãƒ«ãƒ»æœ¬æ—¥ãƒ©ãƒ™ãƒ«ç”¨ãƒ©ãƒƒãƒ‘ãƒ¼
            const dateLabelWrapper = document.createElement("div");
            dateLabelWrapper.className = "date-label-wrapper";

            // æ—¥ä»˜æ•°å­—
            const dateNumber = document.createElement("span");
            dateNumber.className = "date-number";
            dateNumber.textContent = day;
            dateLabelWrapper.appendChild(dateNumber);

            // ã‚»ãƒ«ã«ãƒ©ãƒ™ãƒ«ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’è¿½åŠ 
            div.appendChild(dateLabelWrapper);

            // ğŸ‚ ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç‰¹åˆ¥ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’å‡ºã™
            div.addEventListener("dblclick", () => {
              const clickedDate = formatDateKey(date);  // "YYYY-MM-DD"
              handleDayDblClick(clickedDate);
            });


            calendarEl.appendChild(div);
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆã¨ç¥æ—¥ã‚’å–å¾—ãƒ»æç”»
        const events = await fetchEvents(year, month);
        renderEvents(events);

        const holidays = await fetchHolidays(year, month);
        markHolidays(holidays);




        // ãƒ©ãƒ³ãƒç”»åƒæ›´æ–°
        const lunchImg = document.getElementById("lunch-img");
        const yearStr = year.toString();
        const monthStr = (month + 1).toString().padStart(2, "0");
        
        // ç”»åƒè¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
        lunchImg.style.display = "block";
        
        // å¹´æœˆã«å¿œã˜ãŸç”»åƒURLã‚’ç”Ÿæˆ
        lunchImg.src = `https://blog-imgs-163.fc2.com/o/k/u/okusawanasa/${yearStr}${monthStr}L.pngtest`;

        // ç”»åƒãŒè¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°éè¡¨ç¤ºã«ã™ã‚‹
        lunchImg.onerror = () => {lunchImg.style.display = "none"}; 









        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†ç™»éŒ²ï¼
        addPopupListeners();
        
    
        }




        // æœˆç§»å‹•ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById("prevMonth").addEventListener("click", () => {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        renderCalendar(currentYear, currentMonth);
        });

        document.getElementById("nextMonth").addEventListener("click", () => {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        renderCalendar(currentYear, currentMonth);
        });


            function escapeHtml(text) {
              return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");
            }


            function linkify(text) {
            // URLã£ã½ã„éƒ¨åˆ†ã‚’æ­£è¦è¡¨ç¾ã§æ¤œå‡ºã—ã€ãƒªãƒ³ã‚¯ã‚¿ã‚°ã«ç½®ãæ›ãˆ
            const urlPattern = /(\bhttps?:\/\/[^\s]+)/g;
            return text.replace(urlPattern, (url) => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
            }




    

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDã¨APIã‚­ãƒ¼
    const calendarId = "51aafdeb8745269ae00580275d4dc234653595336bc3fbd5b7f720b5a70cc497@group.calendar.google.com";
    const apiKey = "AIzaSyAF74bBMmb3lHO9t9HKRI0vFQkrC_WrcdY";
    const holidayCalendarId = "japanese__ja@holiday.calendar.google.com";

    function normalizeDescription(text) {
      if (!text) return "";

      return text
        .replace(/<br\s*\/?>/gi, "\n")     // <br> â†’ æ”¹è¡Œ
        .replace(/<[^>]+>/g, "")           // â† â˜…HTMLã‚¿ã‚°å…¨éƒ¨é™¤å»
        .replace(/\u200b/g, "")             // ã‚¼ãƒ­å¹…ã‚¹ãƒšãƒ¼ã‚¹
        .replace(/ï¼š/g, ":")                // å…¨è§’ã‚³ãƒ­ãƒ³
        .replace(/[ï¼»ã€]/g, "[")
        .replace(/[ï¼½ã€‘]/g, "]")
        .replace(/\r\n/g, "\n")
        .trim();
    }

    function extractColorId(event) {
      if (!event.description) return "1";

      const text = normalizeDescription(event.description);
      const match = text.match(/\[COLOR\s*[:=]\s*(\d{1,2})\]/i);
      return match ? match[1] : "1";
    }

    function extractThumbnailUrl(event) {
      if (!event.description) return null;

      const text = normalizeDescription(event.description);

      const match = text.match(
        /\[THUMB\s*[:=]\s*(https?:\/\/[^\]\n]+)\]/i
      );

      return match ? match[1] : null;
    }



    async function fetchEvents(year, month) {
        const startDate = new Date(year, month, -6);
        const endDate = new Date(year, month + 1, 7);

        // æ™‚åˆ»ã‚’1æ—¥åˆ†ãã£ã¡ã‚Šå«ã‚ã‚‹ã‚ˆã†ã«èª¿æ•´
        startDate.setHours(0, 0, 0, 0);
        endDate.setHours(23, 59, 59, 999);

        const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(
            calendarId
        )}/events?key=${apiKey}&timeMin=${startDate.toISOString()}&timeMax=${endDate.toISOString()}&singleEvents=true&orderBy=startTime`;

        const res = await fetch(url);
        const data = await res.json();
        return data.items;
        }


    // é™¤å¤–ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆåï¼ˆç¥æ—¥ã˜ã‚ƒãªã„è¡Œäº‹ï¼‰
    const excludeHolidays = [
      "ç¯€åˆ†",
      "é››ç¥­ã‚Š",
      "æ¯ã®æ—¥",
      "ä¸ƒå¤•",
      "ä¸ƒäº”ä¸‰",
      "ã‚¯ãƒªã‚¹ãƒã‚¹",
      "éŠ€è¡Œä¼‘æ¥­æ—¥",
    ];

    async function fetchHolidays(year, month) {
      const startDate = new Date(year, month, 1).toISOString();
      const endDate = new Date(year, month + 1, 0).toISOString();

      const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(
        holidayCalendarId
      )}/events?key=${apiKey}&timeMin=${startDate}&timeMax=${endDate}&singleEvents=true&orderBy=startTime`;

      const res = await fetch(url);
      const data = await res.json();

      // é™¤å¤–ãƒªã‚¹ãƒˆã«å…¥ã£ã¦ã„ãªã„ã‚‚ã®ã ã‘è¿”ã™
      return data.items.filter(ev => !excludeHolidays.includes(ev.summary));
    }

    function renderEvents(events) {
    // æ—¥ä»˜ã”ã¨ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    const eventsByDay = {};

    events.forEach((event) => {
        const start = new Date(event.start.date || event.start.dateTime);
        const day = formatDateKey(start); // â† "YYYY-MM-DD" å½¢å¼

        if (!eventsByDay[day]) eventsByDay[day] = [];
        eventsByDay[day].push(event);
    });



    //ã€€ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰æ™‚é–“ã¨å†…å®¹ã‚’å–å¾—
    function splitTitle(summary) {
      if (!summary) return { time: "", title: "" };

      // ã€Œæ™‚é–“ + å…¨è§’ or åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ + å†…å®¹ã€
      const match = summary.match(/^(.+?)\s+(.+)$/);

      if (!match) {
        return { time: summary, title: "" };
      }

      return {
        time: match[1],
        title: match[2],
      };
    }



    //ã€€ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰é–‹å§‹æ™‚é–“å–å¾—ï¼ˆã‚½ãƒ¼ãƒˆã®ç‚ºï¼‰
    function extractStartTime(summary) {
      if (!summary) return 9999;

      // ä¾‹:
      // 16~19æ™‚
      // 17:30~
      // 9~
      const match = summary.match(/^(\d{1,2})(?::(\d{2}))?/);

      if (!match) return 9999;

      const hour = parseInt(match[1], 10);
      const minute = match[2] ? parseInt(match[2], 10) : 0;

      return hour * 60 + minute; // åˆ†å˜ä½ã§è¿”ã™
    }



    // å„æ—¥ã®ã‚»ãƒ«ã«å¯¾ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚½ãƒ¼ãƒˆã—ã¦è¿½åŠ 
    Object.entries(eventsByDay).forEach(([day, dayEvents]) => {
        const cell = document.querySelector(`.day[data-day="${day}"]`);
        if (cell) {
        // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆå‰Šé™¤
        cell.querySelectorAll(".event").forEach(el => el.remove());



        // ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã€Œæ™‚é–“ã€ã§ä¸¦ã³æ›¿ãˆ
        dayEvents.sort(
                        (a, b) =>
                          extractStartTime(a.summary) - extractStartTime(b.summary)
                      );

        // å„ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¡¨ç¤º
        dayEvents.forEach(event => {

            // ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¡¨ç¤º
            const div = document.createElement("div");
            div.classList.add("event");




            // èª¬æ˜æ¬„ã® [COLOR:x] ã‚’ä½¿ã†
            const colorId = extractColorId(event); // â† ã“ã“ãŒå¤‰æ›´ç‚¹
            div.classList.add(`color-${colorId}`);

            div.textContent = event.summary;


              // ğŸŒŸ ã‚µãƒ ãƒã‚¤ãƒ«å‡¦ç†
            const rawThumb = extractThumbnailUrl(event);
            const thumbUrl = rawThumb ? normalizeThumbUrl(rawThumb) : null;

            if (thumbUrl) {
              // ===== ã‚µãƒ ãƒã‚ã‚Šï¼šå¾“æ¥è¡¨ç¤º =====
              div.textContent = event.summary;
              const img = document.createElement("img");
              img.src = thumbUrl;
              img.className = "thumbnail";
              div.appendChild(img);
              div.classList.add("has-thumbnail");

            } else {
              // ===== ã‚µãƒ ãƒãªã—ï¼š2è¡Œãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ =====
              const { time, title } = splitTitle(event.summary);
              div.classList.add("no-thumbnail");
              div.innerHTML = `
                <div class="event-time">${time}</div>
                <div class="event-title">${title}</div>
              `;
            }
            

            // ã‚¯ãƒªãƒƒã‚¯æ™‚ã«è©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
            div.addEventListener("click", () => {
            const popup = document.getElementById("popup");
            const overlay = document.getElementById("overlay");
            const content = document.getElementById("popup-content");
            content.innerHTML = "";

            // å†…å®¹ä¾‹ï¼šã‚¿ã‚¤ãƒˆãƒ« + æ—¥ä»˜ + è©³ç´°èª¬æ˜ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
            let description = event.description
              ? stripMetaTags(event.description)
              : "è©³ç´°æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";

            // FC2ç”»åƒURLã®æŠ½å‡º
            let imageUrls = extractImageUrls(description);

            // é‡è¤‡é™¤å»
            imageUrls = [...new Set(imageUrls)];

            let imageHtml = "";
            
            if (imageUrls.length > 0) {
               imageUrls.forEach(url => {
                // <a>ã€œ</a> ã§å›²ã¾ã‚Œã¦ã‚‹ã‚‚ã®ã”ã¨å‰Šé™¤
                const urlPattern = new RegExp(`<a[^>]*>${url.replace(/\//g, "\\/")}</a>`, "g");
                description = description.replace(urlPattern, "");
                // å¿µã®ãŸã‚ç”Ÿã®URLã‚‚å‰Šé™¤
                description = description.replace(url, "");
              });

                // æ¬¡ã« HTML ã«ç”»åƒã‚’è¿½åŠ 
                imageHtml = imageUrls.map(url => `
                  <a href="${url}" target="_blank" rel="noopener noreferrer">
                    <img src="${url}" alt="ã‚¤ãƒ™ãƒ³ãƒˆç”»åƒ" style="width:75%; margin-top:10px; border-radius:8px;">
                  </a>
                `).join("");
              }


            // ç”»åƒURLã‚’é™¤å¤–ã—ã¦ãƒªãƒ³ã‚¯åŒ–
            const formattedDescription = description
              .split('\n')  // è¡Œå˜ä½ã§åˆ†å‰²ï¼ˆæ”¹è¡Œã‚’ä¿æŒï¼‰
              .map(line => {
                return line
                  .split(/(\s+)/)  // ç©ºç™½ã‚’å«ã‚ã¦åˆ†å‰²ï¼ˆâ†’ç©ºç™½ã‚’ç¶­æŒï¼‰
                  .map(part => {
                    // URLãªã‚‰ãƒªãƒ³ã‚¯ã«ï¼ˆç”»åƒURLã¯é™¤å¤–ï¼‰
                    if (/^https?:\/\/[^\s<>"']+$/.test(part)) {
                      return imageUrls.includes(part)
                        ? ""  // ç”»åƒURLã¯ç„¡è¦–
                        : `<a href="${part}" target="_blank" rel="noopener noreferrer">${part}</a>`;
                    } else {
                      return part;
                    }
                  })
                  .join('');
              })
              .join('<br>');



            const start = event.start.dateTime || event.start.date || "";

            
            
            // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            const formatDate = (dt) => {
                if (!dt) return "";
                const d = new Date(dt);
                return d.toLocaleString("ja-JP", {year:"numeric", month:"long", day:"numeric", weekday:"short"});
                }

            content.innerHTML = `
              <p><h3>${formatDate(start)}</h3></p>
              <div style="font-size: 16px; line-height: 1.5;">${formattedDescription}</div>
              ${imageHtml}
            `;

            popup.style.display = "block";
            overlay.style.display = "block";
            });



            cell.appendChild(div);
        });
        }
    });



    // ğŸŒŸ ã‚¤ãƒ™ãƒ³ãƒˆãŒ1ä»¶ã‚‚ç„¡ã„æ—¥ â†’ ä¼‘ãƒãƒ¼ã‚¯ï¼ˆå…¨æ—¥ä»˜å¯¾è±¡ï¼‰
    document.querySelectorAll(".day").forEach(cell => {
      const hasEvent = cell.querySelector(".event");
      const hasClosed = cell.querySelector(".closed-day");

      if (!hasEvent && !hasClosed) {
        const div = document.createElement("div");
        div.classList.add("closed-day");
        div.textContent = "ä¼‘";
        cell.appendChild(div);
      }
    });



    // å…¨ã‚»ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’èª¿æ•´ã—ã¦å‡ç­‰ã«åã‚ã‚‹
    document.querySelectorAll(".day").forEach(adjustCellEvents);


    }



    
    //å‡ç­‰å‰²ã‚Šä»˜ã‘ç™ºå‹•
    function adjustCellEvents(cell) {
      const events = cell.querySelectorAll(".event:not(.has-thumbnail):not(.no-thumbnail)");
      if (events.length === 0) return;

      // ä¸€åº¦ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
      events.forEach(event => {
        const fullText = event.dataset.fullText || event.textContent;
        event.dataset.fullText = fullText;
        event.textContent = fullText;

        // ã‚¹ã‚¿ã‚¤ãƒ«åˆæœŸåŒ–
        event.style.height = "";
        event.style.lineHeight = "";
        event.style.whiteSpace = "";
        event.style.overflow = "";
        event.style.textOverflow = "";
        event.style.display = "";
        event.style.webkitLineClamp = "";
        event.style.webkitBoxOrient = "";
      });

      // ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã™ã¹ã¦è¡¨ç¤ºã—ã¦ã‹ã‚‰ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼åˆ¤å®š
      const isOverflowing = cell.scrollHeight > cell.clientHeight;

      if (!isOverflowing) {
        // æ–‡å­—åˆ‡ã‚ŒãŒãªã„ãªã‚‰ã€ãªã«ã‚‚ã›ãšè‡ªç„¶è¡¨ç¤º
        return;
      }

      // â†“ã“ã“ã‹ã‚‰ã€Œè©°ã¾ã£ã¦ã‚‹æ™‚ã€ã ã‘ç™ºå‹•

      const labelWrapper = cell.querySelector(".date-label-wrapper");
      const labelHeight = labelWrapper ? labelWrapper.getBoundingClientRect().height : 0;
      const cellHeight = cell.getBoundingClientRect().height;
      const availableHeight = cellHeight - labelHeight;
      const safeHeight = availableHeight - 2;
      const eventHeight = Math.floor(safeHeight / events.length);


      events.forEach(event => {
        const fullText = event.dataset.fullText;
        event.textContent = fullText; // çœç•¥ã›ãšå…¨æ–‡

        // ä¸€æ™‚çš„ã«é«˜ã•ã‚’è‡ªå‹•ã«ã—ã¦ã€scrollHeight ã‚’è¨ˆæ¸¬
        event.style.height = "auto";
        event.style.display = "block"; // ä¸€æ™‚çš„ã«é€šå¸¸ãƒ–ãƒ­ãƒƒã‚¯è¡¨ç¤º
        const requiredHeight = event.scrollHeight;

        if (requiredHeight > eventHeight) {
          // â›” å‡ç­‰å¹…ã«åã‚ã‚‹å¿…è¦ã‚ã‚Š
          event.style.height = `${eventHeight}px`;
          event.style.lineHeight = "1.2em";
          event.style.whiteSpace = "normal";
          event.style.overflow = "hidden";
          event.style.textOverflow = "ellipsis";
          event.style.display = "-webkit-box";
          event.style.webkitBoxOrient = "vertical";
          event.style.webkitLineClamp = Math.floor(eventHeight / 16);
        } else {
          // âœ… é«˜ã•è¶³ã‚Šã¦ã‚‹ã®ã§è‡ªç„¶è¡¨ç¤ºï¼ˆæœ€å°é™ã®æŠ˜ã‚Šè¿”ã—å¯¾å¿œã ã‘å…¥ã‚Œã‚‹ï¼‰
          event.style.height = "auto";
          event.style.whiteSpace = "normal";
          event.style.overflow = "hidden";
          event.style.textOverflow = "ellipsis";
          event.style.display = "block";
        }
      });
    }








    // è¤‡æ•°ã®FC2ç”»åƒURLã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
    function extractImageUrls(text) {
      const regex = /https?:\/\/[^\s<>"']+\.(?:jpg|jpeg|png|gif)/gi;
      return text.match(regex) || [];
    }



    function formatDateKey(date) {
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
        }

    function markHolidays(holidays) {
      holidays.forEach((holiday) => {
        const start = new Date(holiday.start.date);
        const day = formatDateKey(start);
        const cell = document.querySelector(`.day[data-day="${day}"]`);
        if (cell) {
          cell.classList.add("holiday");

     
        const wrapper = cell.querySelector(".date-label-wrapper");
        if (wrapper) {
            // ç¥æ—¥ãƒ©ãƒ™ãƒ«ã‚’æŒ¿å…¥
            const holidayLabel = document.createElement("span");
            holidayLabel.className = "holiday-label";
            holidayLabel.textContent = holiday.summary;
            wrapper.appendChild(holidayLabel);
        }
        }
    });

    // æœ¬æ—¥ãƒãƒ¼ã‚¯ã‚’åˆ¥å‡¦ç†ã§ãƒ©ãƒ™ãƒ«è¿½åŠ ï¼ˆç¥æ—¥ã¨å…±å­˜å¯ï¼‰
    const todayCell = document.querySelector(".day.today");
    if (todayCell) {
        const wrapper = todayCell.querySelector(".date-label-wrapper");
        if (wrapper && !wrapper.querySelector(".today-label")) {
        const todayLabel = document.createElement("span");
        todayLabel.className = "today-label";
        todayLabel.textContent = "æœ¬æ—¥";
        wrapper.appendChild(todayLabel);
        }
    }
    }


    function addPopupListeners() {
    const popupClose = document.getElementById("popup-close");
    const overlay = document.getElementById("overlay");

    if (popupClose && overlay) {
        popupClose.addEventListener("click", () => {
        document.getElementById("popup").style.display = "none";
        document.getElementById("overlay").style.display = "none";
        });
        overlay.addEventListener("click", () => {
        document.getElementById("popup").style.display = "none";
        document.getElementById("overlay").style.display = "none";
        });
    }
    }






    async function initCalendar() {
        renderCalendar(currentYear, currentMonth);



       // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ãƒ»ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™»éŒ²
        document.getElementById("popup-close").addEventListener("click", () => {
            document.getElementById("popup").style.display = "none";
            document.getElementById("overlay").style.display = "none";
            document.getElementById("popup-content").innerHTML = "";
        });
        document.getElementById("overlay").addEventListener("click", () => {
            document.getElementById("popup").style.display = "none";
            document.getElementById("overlay").style.display = "none";
            document.getElementById("popup-content").innerHTML = "";
        });

    }

        window.changeMonth = function(diff) {
        currentMonth += diff;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        } else if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        renderCalendar(currentYear, currentMonth);
        };




    initCalendar();




    const handleDayDblClick = (date) => {
      const birthday = new Date("2025-09-27");
      const clickedDate = new Date(date);
      if (
        clickedDate.getFullYear() === birthday.getFullYear() &&
        clickedDate.getMonth() === birthday.getMonth() &&
        clickedDate.getDate() === birthday.getDate()
      ) {
        showSpecialBirthdayPopup();
      } else {
        // é€šå¸¸ã®ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ï¼ˆã‚ã‚Œã°ï¼‰
      }
    };


    function showSpecialBirthdayPopup() {
      const popup = document.createElement("div");
      popup.style.position = "fixed";
      popup.style.top = "50%";
      popup.style.left = "50%";
      popup.style.transform = "translate(-50%, -50%)";
      popup.style.padding = "20px";
      popup.style.background = "white";
      popup.style.border = "2px solid black";
      popup.style.zIndex = 9999;

      // YouTubeåŸ‹ã‚è¾¼ã¿
      popup.innerHTML = `
        <h2>9/27ã¯ã‚µãƒ€ã®èª•ç”Ÿæ—¥ã§ã£ã›</h2>
        <p></p>
        <iframe width="360" height="215" src="https://www.youtube.com/embed/fFwrmTvZmoY" 
          frameborder="0" allowfullscreen></iframe>
        <br><br>
        <button onclick="this.parentElement.remove()">é–‰ã˜ã‚‹</button>
      `;

      document.body.appendChild(popup);
    }

    

    function stripMetaTags(text) {
      return text
        .replace(/\[COLOR[:=]\s*\d{1,2}\]/gi, "")
        .replace(/\[THUMB[:=]\s*[^\]\r\n]+\]/gi, "")
        .trim();
    }

    function normalizeThumbUrl(url) {
      if (!url) return null;

      let m;

      // drive.google.com/file/d/ID/view
      m = url.match(/drive\.google\.com\/file\/d\/([^/]+)/);
      if (m) {
        return `https://drive.google.com/uc?id=${m[1]}`;
      }

      // drive.google.com/open?id=ID
      m = url.match(/drive\.google\.com\/open\?id=([^&]+)/);
      if (m) {
        return `https://drive.google.com/uc?id=${m[1]}`;
      }

      // drive.usercontent.google.com/download?id=ID
      m = url.match(/id=([^&]+)/);
      if (m) {
        return `https://drive.google.com/uc?id=${m[1]}`;
      }

      // ã™ã§ã« uc?id=
      if (url.includes("drive.google.com/uc?id=")) {
        return url;
      }

      return url; // GitHub raw ç­‰
    }





  </script>


    <!-- ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div id="popup" style="display:none; position:fixed; top:50%; left:50%; transform: translate(-50%, -50%);
    background:#fff; border:1px solid #ccc; padding:16px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index:1000;text-align: center; width: 50vw; max-width: 600px; max-height: 80%; overflow:auto;border-radius: 8px;">
    <button id="popup-close" style="position:absolute; top:8px; right:8px; background:none; border:none; font-size:16px; cursor:pointer;">âœ–</button>
    <div id="popup-content"></div>
    </div>

    <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:999;"></div>

    <BR>

<!-- æ³¨æ„æ›¸ã
<div style="text-align:center; margin: 1.5em auto; padding: 1.2em; 
            background:#fff3cd; border:1px solid #ffecb5; 
            border-radius:8px; max-width:700px; 
            box-shadow:0 2px 6px rgba(0,0,0,0.15);">
  <p style="margin:0; font-weight:bold; color:#664d03; font-size:1.2em;">
    âš ï¸ æ–‡ç« ã‚„ãƒªãƒ³ã‚¯é…ç½®ã§ãã¾ã™ï¼
  </p>
  <p style="margin:0.5em 0 0;font-size:1.2em;">
    <a href="https://www.nasaspace.at/schedule/bar/" target="_blank" 
       style="color:#0d6efd; font-weight:bold; text-decoration:underline;">
       è©³ã—ãã¯ã‚³ãƒãƒ©
    </a>
  </p>
</div>
 -->
    <BR>
      
    <!-- ãƒ©ãƒ³ãƒå–¶æ¥­äºˆå®š -->
    <img id="lunch-img"
          src=""
          alt="ãƒ©ãƒ³ãƒå–¶æ¥­äºˆå®š"
          style="max-width:70%; height:auto; display:block; margin:0 auto;">

</body>
</html>