<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel="stylesheet">

  <title>ã‚¹ãƒãƒ›ç”¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
  <style>

    body {
      font-family: 'Noto Sans JP', 'Segoe UI', sans-serif;
      color: #444;
      margin: 0;
      padding: 0;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      border-top: 1px solid #ccc;
      border-left: 1px solid #ccc;
    }




    .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 10px;
    font-size: 18px;
    font-weight: bold;
    }
        



    .weekday-header {
      background: #f0f0f0;
      text-align: center;
      font-weight: bold;
      font-size: 16px;
      height: 30px;       /* â† ã“ã®è¡Œã‚’è¿½åŠ /èª¿æ•´ */
      line-height: 30px;  /* â† ç¸¦ä¸­å¤®æƒãˆ */
      color: #666;
      border-right: 1px solid #ccc;  /* å³å´ã«ç¸¦ç·š */
      border-bottom: 1px solid #ccc;
    }

    .weekday-header.sun {
    color: rgb(167, 59, 59); /* èµ¤ï¼ˆæ—¥æ›œï¼‰ */
    }

    .weekday-header.sat {
    color: rgb(59, 59, 136); /* é’ï¼ˆåœŸæ›œï¼‰ */
    }

    .day,
    .day-header {
      border-right: 1px solid #ccc;
      border-bottom: 1px solid #ccc;
      padding: 4px 1px;
      box-sizing: border-box;
      height: 160px;
      overflow-y: auto;
      font-size: 14px;
      position: relative;
    }

    .date-label-wrapper {
    display: flex;
    align-items: center;
    gap: 4px;
    }

    .date-number {
    font-weight: bold;
    font-size: 14px;
    }



    .sun {
      background-color: #ffe5e5;
    }
    .sat {
      background-color: #e5f0ff;
    }
    .holiday {
      background-color: #ffe5e5 !important;
    }
    .holiday-label {
    font-weight: bold;
    font-size: 13px;
    color: #d9534f;  /* èµ¤ã£ã½ã„è‰² */
    margin-left: 4px;
    }

    .today {
    background-color: #a4f7fd !important; /* æ°´è‰²èƒŒæ™¯ */
    }
    .today-label {
    font-weight: bold;
    font-size: 13px;
    color: #003caa;
    margin-left: 4px;
    }


    .event {
      font-size: 14px;
      margin: 2px 0px;
      padding: 1px 0px;
      border-radius: 3px;
      color: white;
      display: block;
      white-space: normal;
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 100%;
    }


    #prevMonth, #nextMonth {
      font-size: 24px;      /* æ–‡å­—ã‚’å¤§ãã */
      padding: 10px 20px;   /* ãƒœã‚¿ãƒ³ã®å†…å´ã®ä½™ç™½ã‚’å¢—ã‚„ã™ */
      min-width: 80px;      /* å¹…ã®æœ€å°å€¤ */
      min-height: 40px;     /* é«˜ã•ã®æœ€å°å€¤ */
      cursor: pointer;      /* ãƒ›ãƒãƒ¼æ™‚ã®ã‚«ãƒ¼ã‚½ãƒ« */
      border-radius: 6px;   /* è§’ã‚’å°‘ã—ä¸¸ã */
      user-select: none;    /* ã‚¯ãƒªãƒƒã‚¯æ™‚ã«æ–‡å­—é¸æŠã•ã‚Œãªã„ */
    }


    @media screen and (max-width: 600px) {
    .event {
      font-size: 10px;
      margin: 2px 0px;
      padding: 1px 0px;
    }
    .day,
    .day-header {
      font-size: 11px; /* å…¨ä½“çš„ã«æ–‡å­—ã‚’å°‘ã—å°ã•ã */
      height: 130px;   /* é«˜ã•ã‚‚å°‘ã—ä½ãã—ã¦ã‚¹ãƒãƒ›ã«åˆã‚ã›ã‚‹ */
    }
    .weekday-header {
      font-size: 12px;
      height: 24px;
      line-height: 24px;
    }
  }


  </style>
</head>







<body>


    <div class="calendar-header">
    <button id="prevMonth">å‰æœˆ</button>
    <h2 id="monthYear"></h2>
    <button id="nextMonth">ç¿Œæœˆ</button>
    </div>

    <div class="calendar">
        <!-- æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="weekday-header sun">æ—¥</div>
        <div class="weekday-header">æœˆ</div>
        <div class="weekday-header">ç«</div>
        <div class="weekday-header">æ°´</div>
        <div class="weekday-header">æœ¨</div>
        <div class="weekday-header">é‡‘</div>
        <div class="weekday-header sat">åœŸ</div>
        
        <!-- ã“ã“ã«JavaScriptã§æ—¥ã”ã¨ã®.dayãŒå…¥ã‚‹ -->
    </div>






  <script>
        const now = new Date();
        let currentYear = now.getFullYear();
        let currentMonth = now.getMonth(); // 0-11

        const calendarEl = document.querySelector(".calendar");





        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†æç”»ç”¨
        async function renderCalendar(year, month) {
        calendarEl.innerHTML = ""; // æ—¢å­˜ã‚¯ãƒªã‚¢

        // ğŸŒŸ æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
        const weekdays = ["æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ", "æ—¥"];
        weekdays.forEach((day, index) => {
            const headerCell = document.createElement("div");
            headerCell.className = "weekday-header";

            if (index === 6) headerCell.classList.add("sun");  // æ—¥æ›œ
            if (index === 5) headerCell.classList.add("sat");  // åœŸæ›œ

            headerCell.textContent = day;
            calendarEl.appendChild(headerCell);
        });

        const firstDay = new Date(year, month, 1);
        const rawStartDay = firstDay.getDay(); // 0=æ—¥æ›œ, 1=æœˆæ›œ, ...
        const startDay = (rawStartDay + 6) % 7; // æœˆæ›œ=0, æ—¥æ›œ=6 ã«å¤‰æ›


        // å‰æœˆã®æƒ…å ±
        const prevMonth = month - 1 < 0 ? 11 : month - 1;
        const prevYear = month - 1 < 0 ? year - 1 : year;
        const prevMonthLastDate = new Date(prevYear, prevMonth + 1, 0).getDate();

        // å½“æœˆã®æ—¥æ•°
        const daysInMonth = new Date(year, month + 1, 0).getDate();


        // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæœˆãƒ©ãƒ™ãƒ«ï¼‰æ›´æ–°
        document.getElementById("monthYear").textContent = `${year}å¹´${month + 1}æœˆ`;



                
        // ğŸŒŸ å‰æœˆã®æ—¥ä»˜ã‚»ãƒ«ã‚’è¿½åŠ ï¼ˆç©ºç™½ã§ã¯ãªãï¼‰
        for (let i = startDay - 1; i >= 0; i--) {
            const date = new Date(prevYear, prevMonth, prevMonthLastDate - i);
            const div = document.createElement("div");
            div.className = "day";
            div.setAttribute("data-day", formatDateKey(date));

            const dow = date.getDay();
            if (dow === 0) div.classList.add("sun");
            if (dow === 6) div.classList.add("sat");

            // æœ¬æ—¥åˆ¤å®š
            const now = new Date();
            const isToday = (
                date.getFullYear() === now.getFullYear() &&
                date.getMonth() === now.getMonth() &&
                date.getDate() === now.getDate()
            );
            if (isToday) div.classList.add("today");

            // ãƒ©ãƒ™ãƒ«è¡¨ç¤º
            const dateLabelWrapper = document.createElement("div");
            dateLabelWrapper.className = "date-label-wrapper";

            const dateNumber = document.createElement("span");
            dateNumber.className = "date-number";
            dateNumber.textContent = date.getDate();
            dateLabelWrapper.appendChild(dateNumber);

            div.appendChild(dateLabelWrapper);
            calendarEl.appendChild(div);
        }



        // ğŸŒŸ 2. å½“æœˆã®æ—¥ä»˜ã‚»ãƒ«ã‚’è¿½åŠ 
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const div = document.createElement("div");
            div.className = "day";
            div.setAttribute("data-day", formatDateKey(date));

            const dow = date.getDay();
            if (dow === 0) div.classList.add("sun");
            if (dow === 6) div.classList.add("sat");

            // æœ¬æ—¥åˆ¤å®š
            const now = new Date();
            const isToday =
                    date.getFullYear() === now.getFullYear() &&
                    date.getMonth() === now.getMonth() &&
                    date.getDate() === now.getDate();
            if (isToday) div.classList.add("today");

            // æ—¥ä»˜ãƒ©ãƒ™ãƒ«ãƒ»ç¥æ—¥ãƒ©ãƒ™ãƒ«ãƒ»æœ¬æ—¥ãƒ©ãƒ™ãƒ«ç”¨ãƒ©ãƒƒãƒ‘ãƒ¼
            const dateLabelWrapper = document.createElement("div");
            dateLabelWrapper.className = "date-label-wrapper";

            // æ—¥ä»˜æ•°å­—
            const dateNumber = document.createElement("span");
            dateNumber.className = "date-number";
            dateNumber.textContent = day;
            dateLabelWrapper.appendChild(dateNumber);

            // ã‚»ãƒ«ã«ãƒ©ãƒ™ãƒ«ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’è¿½åŠ 
            div.appendChild(dateLabelWrapper);


            calendarEl.appendChild(div);
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆã¨ç¥æ—¥ã‚’å–å¾—ãƒ»æç”»
        const events = await fetchEvents(year, month);
        renderEvents(events);

        const holidays = await fetchHolidays(year, month);
        markHolidays(holidays);


        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†ç™»éŒ²ï¼
        addPopupListeners();
        
    
        }




        // æœˆç§»å‹•ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById("prevMonth").addEventListener("click", () => {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        renderCalendar(currentYear, currentMonth);
        });

        document.getElementById("nextMonth").addEventListener("click", () => {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        renderCalendar(currentYear, currentMonth);
        });




            function linkify(text) {
            // URLã£ã½ã„éƒ¨åˆ†ã‚’æ­£è¦è¡¨ç¾ã§æ¤œå‡ºã—ã€ãƒªãƒ³ã‚¯ã‚¿ã‚°ã«ç½®ãæ›ãˆ
            const urlPattern = /(\bhttps?:\/\/[^\s]+)/g;
            return text.replace(urlPattern, (url) => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
            }




    

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDã¨APIã‚­ãƒ¼
    const calendarId = "sadaharuchallenge@gmail.com";
    const apiKey = "AIzaSyDCdmcXSeIaZTPnSJmNo5B8SdvjRakhF4A";
    const holidayCalendarId = "japanese__ja@holiday.calendar.google.com";

    // è‰²ID â†’ CSSã‚«ãƒ©ãƒ¼ã®ç°¡æ˜“ãƒãƒƒãƒ—
    const colorMap = {
      "1": "#2952A3", // é’
      "4": "#d94e3b", // â† ã“ã‚ŒãŒã€Œæœ±è‰²ã€ï¼
      "5": "#FBD75B", // é»„è‰²ç³»
      "6": "#FF9900", // ã‚ªãƒ¬ãƒ³ã‚¸
      "9": "#4A86E8", // æ°´è‰²
      "11": "#A7A7A7", // ç°è‰²
    };

    async function fetchEvents(year, month) {
        const startDate = new Date(year, month, -6).toISOString(); // â† å‰æœˆã®æœ«é€±é–‹å§‹ï¼ˆç´„1é€±é–“å‰ï¼‰
        const endDate = new Date(year, month + 1, 7).toISOString(); // â† ç¿Œæœˆã®é ­ã‚‚å°‘ã—å«ã‚€

        const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(
            calendarId
        )}/events?key=${apiKey}&timeMin=${startDate}&timeMax=${endDate}&singleEvents=true&orderBy=startTime`;

        const res = await fetch(url);
        const data = await res.json();
        return data.items;
        }

    async function fetchHolidays(year, month) {
      const startDate = new Date(year, month, 1).toISOString();
      const endDate = new Date(year, month + 1, 0).toISOString();

      const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(
        holidayCalendarId
      )}/events?key=${apiKey}&timeMin=${startDate}&timeMax=${endDate}&singleEvents=true&orderBy=startTime`;

      const res = await fetch(url);
      const data = await res.json();
      return data.items;
    }

    function renderEvents(events) {
    // æ—¥ä»˜ã”ã¨ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    const eventsByDay = {};

    events.forEach((event) => {
        const start = new Date(event.start.date || event.start.dateTime);
        const day = formatDateKey(start); // â† "YYYY-MM-DD" å½¢å¼

        if (!eventsByDay[day]) eventsByDay[day] = [];
        eventsByDay[day].push(event);
    });


    // é †åºä»˜ã‘ç”¨ã®é–¢æ•°ï¼ˆæ˜¼â†’å¤•æ–¹â†’å¤œï¼‰
    function getTimeOrder(summary) {
        if (summary.includes("æ˜¼")) return 1;
        if (summary.includes("å¤•æ–¹")) return 2;
        if (summary.includes("å¤œ")) return 3;
        return 4; // ãã®ä»–ã¯å¾Œã‚
    }

    // å„æ—¥ã®ã‚»ãƒ«ã«å¯¾ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚½ãƒ¼ãƒˆã—ã¦è¿½åŠ 
    Object.entries(eventsByDay).forEach(([day, dayEvents]) => {
        const cell = document.querySelector(`.day[data-day="${day}"]`);
        if (cell) {
        // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆå‰Šé™¤
        cell.querySelectorAll(".event").forEach(el => el.remove());

        // ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã€Œæ˜¼â†’å¤•æ–¹â†’å¤œã€ã§ä¸¦ã³æ›¿ãˆ
        dayEvents.sort((a, b) => getTimeOrder(a.summary) - getTimeOrder(b.summary));

        // å„ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¡¨ç¤º
        dayEvents.forEach(event => {

            // ã‚¿ã‚¤ãƒˆãƒ«ã®æ–‡å­—ã«å¿œã˜ã¦å¼·åˆ¶çš„ã« colorId ã‚’æ±ºå®š
            let colorId = "1"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’æ±ºã‚ã¦ãŠã
            if (event.summary.includes("ä¼‘æ¥­äºˆå®š")) {
            colorId = "11";  // ç°è‰²
            } else if (event.summary.includes("æ˜¼")) {
            colorId = "6"; // ã‚ªãƒ¬ãƒ³ã‚¸
            } else if (event.summary.includes("å¤•æ–¹")) {
            colorId = "4"; // æœ±è‰²
            } else if (event.summary.includes("å¤œ")) {
            colorId = "1";  // é’
            }
            
            
            const bgColor = colorMap[colorId] || colorMap["1"];  // fallback

            const div = document.createElement("div");
            div.textContent = event.summary;
            div.classList.add("event");
            div.style.backgroundColor = bgColor;



            // ã‚¯ãƒªãƒƒã‚¯æ™‚ã«è©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
            div.addEventListener("click", () => {
            const popup = document.getElementById("popup");
            const overlay = document.getElementById("overlay");
            const content = document.getElementById("popup-content");

            // å†…å®¹ä¾‹ï¼šã‚¿ã‚¤ãƒˆãƒ« + æ—¥ä»˜ + è©³ç´°èª¬æ˜ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
            let description = event.description ? linkify(event.description) : "è©³ç´°æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
            let start = event.start.dateTime || event.start.date || "";
            let end = event.end.dateTime || event.end.date || "";

            // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            const formatDate = (dt) => {
                if (!dt) return "";
                const d = new Date(dt);
                return d.toLocaleString("ja-JP", {year:"numeric", month:"long", day:"numeric", weekday:"short"});
                }

            content.innerHTML = `
                <h3>${event.summary}</h3>
                <p><strong>æ—¥ä»˜:</strong> ${formatDate(start)}</p>
                <p>${description.replace(/\n/g, "<br>")}</p>
            `;

            popup.style.display = "block";
            overlay.style.display = "block";
            });



            cell.appendChild(div);
        });
        }
    });
    }


    function formatDateKey(date) {
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
        }

    function markHolidays(holidays) {
      holidays.forEach((holiday) => {
        const start = new Date(holiday.start.date);
        const day = start.getDate();
        const cell = document.querySelector(`.day[data-day="${day}"]`);
        if (cell) {
          cell.classList.add("holiday");

     
        const wrapper = cell.querySelector(".date-label-wrapper");
        if (wrapper) {
            // ç¥æ—¥ãƒ©ãƒ™ãƒ«ã‚’æŒ¿å…¥
            const holidayLabel = document.createElement("span");
            holidayLabel.className = "holiday-label";
            holidayLabel.textContent = holiday.summary;
            wrapper.appendChild(holidayLabel);
        }
        }
    });

    // æœ¬æ—¥ãƒãƒ¼ã‚¯ã‚’åˆ¥å‡¦ç†ã§ãƒ©ãƒ™ãƒ«è¿½åŠ ï¼ˆç¥æ—¥ã¨å…±å­˜å¯ï¼‰
    const todayCell = document.querySelector(".day.today");
    if (todayCell) {
        const wrapper = todayCell.querySelector(".date-label-wrapper");
        if (wrapper && !wrapper.querySelector(".today-label")) {
        const todayLabel = document.createElement("span");
        todayLabel.className = "today-label";
        todayLabel.textContent = "æœ¬æ—¥";
        wrapper.appendChild(todayLabel);
        }
    }
    }


    function addPopupListeners() {
    const popupClose = document.getElementById("popup-close");
    const overlay = document.getElementById("overlay");

    if (popupClose && overlay) {
        popupClose.addEventListener("click", () => {
        document.getElementById("popup").style.display = "none";
        document.getElementById("overlay").style.display = "none";
        });
        overlay.addEventListener("click", () => {
        document.getElementById("popup").style.display = "none";
        document.getElementById("overlay").style.display = "none";
        });
    }
    }






    async function initCalendar() {
        renderCalendar(currentYear, currentMonth);



       // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ãƒ»ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™»éŒ²
        document.getElementById("popup-close").addEventListener("click", () => {
            document.getElementById("popup").style.display = "none";
            document.getElementById("overlay").style.display = "none";
        });
        document.getElementById("overlay").addEventListener("click", () => {
            document.getElementById("popup").style.display = "none";
            document.getElementById("overlay").style.display = "none";
        });

    }

        window.changeMonth = function(diff) {
        currentMonth += diff;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        } else if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        renderCalendar(currentYear, currentMonth);
        };




    initCalendar();
  </script>


    <!-- ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div id="popup" style="display:none; position:fixed; top:50%; left:50%; transform: translate(-50%, -50%);
    background:#fff; border:1px solid #ccc; padding:16px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index:1000; max-width: 90%; max-height: 80%; overflow:auto;">
    <button id="popup-close" style="position:absolute; top:8px; right:8px; background:none; border:none; font-size:16px; cursor:pointer;">âœ–</button>
    <div id="popup-content"></div>
    </div>

    <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:999;"></div>

</body>
</html>
